# Supabase RLS Fixes — Profiles recursion + Characters CRUD (2025-09-22)

Summary of changes implemented via `sql/2025-09-22-rls-fixes.sql`:

- Removed recursive `profiles` policies that selected from `profiles` inside their own USING/WITH CHECK clauses (this caused “infinite recursion detected”).
- Replaced with safe policies using SECURITY DEFINER helpers:
  - `public.current_user_role()` and `public.current_user_owner_slug()`.
  - Select policies: self, admin within org, superadmin (all).
  - Update policies: self (cannot change role/owner), admin within org (cannot set superadmin), superadmin (all).
  - Delete policy: superadmin only.
- Added `characters` policies to allow INSERT/UPDATE/DELETE for `admin` and `superadmin` while keeping public SELECT.

Verification steps (in Supabase SQL editor):

1) Run the migration SQL file contents.
2) Sign in with a non-admin account and ensure:
   - `select * from profiles where id = auth.uid()` works (no recursion error).
   - `insert into characters(...)` is blocked (not admin).
3) Sign in with admin:
   - `select * from profiles` returns only same-org rows.
   - `insert/update/delete` on `characters` succeeds.
4) Sign in with superadmin:
   - Full access to `profiles` and `characters` as defined above.

Notes:

- If the helper functions from the prior migration are missing, re-run section 7 of `sql/ask-charlie-bot360ai-migrations.sql` to create them, then apply this fix.
- The app’s Admin pages depend on these policies for CSV import and character edits to succeed.
